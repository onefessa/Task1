#include <stdio.h>
#include <math.h>
#include <iostream>
#include <fstream>
#include <cmath>
using namespace std;

double c[8] = {0, 0, 1.0/5, 3.0/10, 4.0/5, 8.0/9, 1.0, 1.0};

double f(double t, double x, double y, double a, double b){
	return y;
}
double g(double t, double x, double y, double a, double b){
//double g(double t,double x, double y, double a, double b){
	return -a*y - pow(x, 3) + b*cos(t);
}

double R_K(double t_0, double T, double x0, double a, double b, int target){
	double k1,k2,k3,k4,k5,k6,k7,l1,l2,l3,l4,l5,l6,l7,x,y,y0,h,tol,err1,err2,err,t,x_roof,y_roof, z, N_st=1;;
	tol = 1./pow(10,9);
	h=0.01;
	y0=0;
	t=t_0;
	z = x0;
	while(t<T){
	    if (t+h > T) {h = T - t;}
        {
		k1 = h*f(t, x0,y0,a,b);
		l1 = h*g(t, x0,y0,a,b);
		k2 = h*f(t+h*1./5, x0 + (1/5.)*k1, y0 + (1/5.)*l1, a,b);
		l2 = h*g(t+h*1./5, x0 + (1/5.)*k1, y0 + (1/5.)*l1, a,b);
		k3 = h*f(t+h*3./10, x0 + (3/40.)*k1 + (9/40.)*k2, y0 + (3/40.)*l1 + (9/40.)*l2, a,b);
		l3 = h*g(t+h*3./10, x0 + (3/40.)*k1 + (9/40.)*k2, y0 + (3/40.)*l1 + (9/40.)*l2, a,b);
		k4 = h*f(t+h*4./5, x0 + (44/45.)*k1 - (56/15.)*k2 + (32/9.)*k3, y0 + (44/45.)*l1 - (56/15.)*l2 + (32/9.)*l3, a,b);
		l4 = h*g(t+h*4./5, x0 + (44/45.)*k1 - (56/15.)*k2 + (32/9.)*k3, y0 + (44/45.)*l1 - (56/15.)*l2 + (32/9.)*l3, a,b);
		k5 = h*f(t+h*8./9, x0 + (19372/6561.)*k1 - (25360/2187.)*k2 + (64448/6561.)*k3 - (212/729.)*k4 ,y0 + (19372/6561.)*l1 - (25360/2187.)*l2 + (64448/6561.)*l3 - (212/729.)*l4, a,b);
		l5 = h*g(t+h*8./9, x0 + (19372/6561.)*k1 - (25360/2187.)*k2 + (64448/6561.)*k3 - (212/729.)*k4 ,y0 + (19372/6561.)*l1 - (25360/2187.)*l2 + (64448/6561.)*l3 - (212/729.)*l4, a,b);
		k6 = h*f(t+1*h, x0 + (9017/3168.)*k1 - (355/33.)*k2 + (46732/5247.)*k3 +(49/176.)*k4 -(5103/18656.)*k5, y0 + (9017/3168.)*l1 - (355/33.)*l2 + (46732/5247.)*l3 +(49/176.)*l4 -(5103/18656.)*l5, a,b);
		l6 = h*g(t+h, x0 + (9017/3168.)*k1 - (355/33.)*k2 + (46732/5247.)*k3 +(49/176.)*k4 -(5103/18656.)*k5, y0 + (9017/3168.)*l1 - (355/33.)*l2 + (46732/5247.)*l3 +(49/176.)*l4 -(5103/18656.)*l5, a,b);
		k7 = h*f(t+h,x0 + (35/384.)*k1 + (500/1113.)*k3 + (125/192.)*k4 - (2187/6784.)*k5 + (11/84.)*k6, y0 + (35/384.)*l1 + (500/1113.)*l3 + (125/192.)*l4 - (2187/6784.)*l5 + (11/84.)*l6, a,b);
		l7 = h*g(t+h, x0 + (35/384.)*k1 + (500/1113.)*k3 + (125/192.)*k4 - (2187/6784.)*k5 + (11/84.)*k6, y0 + (35/384.)*l1 + (500/1113.)*l3 + (125/192.)*l4 - (2187/6784.)*l5 + (11/84.)*l6, a,b);
        }
		x = x0 + (35/384.)*k1 + (500/1113.)*k3 + (125/192.)*k4 - (2187/6784.)*k5 + (11/84.)*k6;
		y = y0 + (35/384.)*l1 + (500/1113.)*l3 + (125/192.)*l4 - (2187/6784.)*l5 + (11/84.)*l6;

		x_roof = x0 +(5179/57600.)*k1 + (7571/16695.)*k3 + (393/640.)*k4 - (92097/339200.)*k5 + (187/2100.)*k6 + (1/40.)*k7;
		y_roof = y0 +(5179/57600.)*l1 + (7571/16695.)*l3 + (393/640.)*l4 - (92097/339200.)*l5 + (187/2100.)*l6 + (1/40.)*l7;

		N_st+=1;

		err1=fabs(x-x_roof);
		err2=fabs(y-y_roof);
		err=fmax(err1,err2);

        if(err<tol){
            x0 = x;
            y0 = y;
        ///t += h;
        }
        else {
            h=h*fmin(1.5, fmax(0.7, 0.9*pow(tol/err, 1./6)));
        }
        ///h=h*fmin(1.5, fmax(0.7, 0.9*pow(tol/err, 1./6)));
        //cout<<t/T<< " err="<< err<< " \th="<< h<< " x0="<< x0<< " y0="<< y0<< endl;
	t += h;
	}
    if (target == 0)
        return (x0 - z);
    else
        return (y0);
}

void task8(double a, double b){
	double k1,k2,k3,k4,k5,k6,k7,l1,l2,l3,l4,l5,l6,l7,x,y,x0,y0,t,T,h,delta,x_11,x_22,x_12,x_21, x_new,
            T_new,eps,tol,x_roof,y_roof,err1,err2,err, N_st, t_0;
	ofstream data ("8.txt");
	delta = 1/pow(10, 8);
	eps = 1/pow(10, 6);
	T=8*M_PI;
    t_0 = 0;
	x0=0.0198; ///a = 0.01;
	//x0=1.07; /// a = 1
	y0=0;
	N_st=1;
	while(pow(pow(R_K(t_0,T,x0,a,b,0), 2) + pow(R_K(t_0,T,x0,a,b,1), 2), 1/2.) > eps){

		x_11 = ((R_K(t_0,T,x0+delta,a,b,0)) - (R_K(t_0,T,x0,a,b,0)))/delta;
		x_12 = ((R_K(t_0,T+delta,x0,a,b,0)) - (R_K(t_0,T,x0,a,b,0)))/delta;

		x_21 = ((R_K(t_0,T,x0+delta,a,b,1)) - (R_K(t_0,T,x0,a,b,1)))/delta;
		x_22 = ((R_K(t_0,T+delta,x0,a,b,1))  - (R_K(t_0,T,x0,a,b,1)))/delta;

		x_new = (x0 - (1/(x_11*x_22 - x_12*x_21))*((R_K(t_0,T,x0,a,b,0))*x_22 - x_12*(R_K(t_0,T,x0,a,b,1))));
		T_new = (T - (1/(x_11*x_22 - x_12*x_21))*(-(R_K(t_0,T,x0,a,b,0))*x_21 + x_11*(R_K(t_0,T,x0,a,b,1))));


		x0 = x_new;
		T = T_new;
		cout<<"----------------------------------------------------------------------------------------------------------"<<endl;
		cout<<"New: x0="<< x0<< " T=" <<T<<endl;
		cout<<"Err: "<< pow(pow(R_K(t_0,T,x0,a,b,0), 2) + pow(R_K(t_0,T,x0,a,b,1), 2), 1/2.) <<endl;
	}
	cout<<"New: \t"<< x0<< " " <<T<<endl;
	tol = 1./pow(10,9);
	h=0.1;
	y0=0;
	t=0;
    while(t<T){
        if (t+h > T) {h = T - t;}
        {
        k1 = h*f(t, x0,y0,a,b);
		l1 = h*g(t, x0,y0,a,b);
		k2 = h*f(t+h*1./5, x0 + (1/5.)*k1, y0 + (1/5.)*l1, a,b);
		l2 = h*g(t+h*1./5, x0 + (1/5.)*k1, y0 + (1/5.)*l1, a,b);
		k3 = h*f(t+h*3./10, x0 + (3/40.)*k1 + (9/40.)*k2, y0 + (3/40.)*l1 + (9/40.)*l2, a,b);
		l3 = h*g(t+h*3./10, x0 + (3/40.)*k1 + (9/40.)*k2, y0 + (3/40.)*l1 + (9/40.)*l2, a,b);
		k4 = h*f(t+h*4./5, x0 + (44/45.)*k1 - (56/15.)*k2 + (32/9.)*k3, y0 + (44/45.)*l1 - (56/15.)*l2 + (32/9.)*l3, a,b);
		l4 = h*g(t+h*4./5, x0 + (44/45.)*k1 - (56/15.)*k2 + (32/9.)*k3, y0 + (44/45.)*l1 - (56/15.)*l2 + (32/9.)*l3, a,b);
		k5 = h*f(t+h*8./9, x0 + (19372/6561.)*k1 - (25360/2187.)*k2 + (64448/6561.)*k3 - (212/729.)*k4 ,y0 + (19372/6561.)*l1 - (25360/2187.)*l2 + (64448/6561.)*l3 - (212/729.)*l4, a,b);
		l5 = h*g(t+h*8./9, x0 + (19372/6561.)*k1 - (25360/2187.)*k2 + (64448/6561.)*k3 - (212/729.)*k4 ,y0 + (19372/6561.)*l1 - (25360/2187.)*l2 + (64448/6561.)*l3 - (212/729.)*l4, a,b);
		k6 = h*f(t+1*h, x0 + (9017/3168.)*k1 - (355/33.)*k2 + (46732/5247.)*k3 +(49/176.)*k4 -(5103/18656.)*k5, y0 + (9017/3168.)*l1 - (355/33.)*l2 + (46732/5247.)*l3 +(49/176.)*l4 -(5103/18656.)*l5, a,b);
		l6 = h*g(t+h, x0 + (9017/3168.)*k1 - (355/33.)*k2 + (46732/5247.)*k3 +(49/176.)*k4 -(5103/18656.)*k5, y0 + (9017/3168.)*l1 - (355/33.)*l2 + (46732/5247.)*l3 +(49/176.)*l4 -(5103/18656.)*l5, a,b);
		k7 = h*f(t+h,x0 + (35/384.)*k1 + (500/1113.)*k3 + (125/192.)*k4 - (2187/6784.)*k5 + (11/84.)*k6, y0 + (35/384.)*l1 + (500/1113.)*l3 + (125/192.)*l4 - (2187/6784.)*l5 + (11/84.)*l6, a,b);
		l7 = h*g(t+h, x0 + (35/384.)*k1 + (500/1113.)*k3 + (125/192.)*k4 - (2187/6784.)*k5 + (11/84.)*k6, y0 + (35/384.)*l1 + (500/1113.)*l3 + (125/192.)*l4 - (2187/6784.)*l5 + (11/84.)*l6, a,b);

        x = x0 + (35/384.)*k1 + (500/1113.)*k3 + (125/192.)*k4 - (2187/6784.)*k5 + (11/84.)*k6;
        y = y0 + (35/384.)*l1 + (500/1113.)*l3 + (125/192.)*l4 - (2187/6784.)*l5 + (11/84.)*l6;

        x_roof = x0 +(5179/57600.)*k1 + (7571/16695.)*k3 + (393/640.)*k4 - (92097/339200.)*k5 + (187/2100.)*k6 + (1/40.)*k7;
        y_roof = y0 +(5179/57600.)*l1 + (7571/16695.)*l3 + (393/640.)*l4 - (92097/339200.)*l5 + (187/2100.)*l6 + (1/40.)*l7;

        N_st+=1;
        }
        err1=fabs(x-x_roof);
        err2=fabs(y-y_roof);
        err=fmax(err1,err2);

        if(err<tol){
            x0 = x;
            y0 = y;
            t += h;
        }
        h=h*fmin(1.5, fmax(0.7, 0.9*pow(tol/err, 1./6)));

        data<<x0<< " "<< y0<<endl;
    }
}
